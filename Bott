from geopy.geocoders import Nominatim

geolocator = Nominatim(user_agent="kwt-bot")  # –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

def add_store_location(update, context):
    loc = update.message.location
    if not loc:
        update.message.reply_text(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
        )
        return ADD_STORE_LOCATION  # –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ

    coords = (loc.latitude, loc.longitude)
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞
    try:
        address = geolocator.reverse(coords).address
    except:
        address = f"{round(coords[0],4)}, {round(coords[1],4)}"

    context.user_data["address"] = address

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω—ã –Ω–∞ —ç—Ç–æ–º –∞–¥—Ä–µ—Å–µ
    shops_at_address = addresses.get(address, [])
    if shops_at_address:
        keyboard = [[s] for s in sorted(shops_at_address)]
        keyboard.append(["‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞"])
        update.message.reply_text(
            f"üè¨ –ú–∞–≥–∞–∑–∏–Ω—ã –Ω–∞ —ç—Ç–æ–º –∞–¥—Ä–µ—Å–µ ({address}):\n–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        )
        return STORE_SELECT

    # –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
    update.message.reply_text(
        f"–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n{address}\n‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞"
    )
    return STORE_NAME
