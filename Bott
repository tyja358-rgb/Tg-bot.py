from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount  # Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ ÑÐºÐ¸Ð´Ð¾Ðº
from db import init_db

TOKEN = "Ð’ÐÐ¨_Ð¢ÐžÐšÐ•Ð_Ð—Ð”Ð•Ð¡Ð¬"

# Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
MAIN_MENU = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ’° KWT / Ð‘Ð°Ñ€"]]

def start(update: Update, context: CallbackContext):
    """Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð±Ð¾Ñ‚Ð° Ð¸ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ"""
    context.user_data.clear()
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:",
        reply_markup=ReplyKeyboardMarkup(
            MAIN_MENU,
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )

def main_menu_handler(update: Update, context: CallbackContext):
    """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ"""
    text = update.message.text

    if text == "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ":
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÐ¸Ð´ÐºÐ¸
        return start_discount(update, context)

    elif text == "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ":
        # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÐºÐ¸Ð´Ð¾Ðº
        update.message.reply_text("ðŸ” Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ'. Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐºÐ¸Ð´Ð¾Ðº Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð·Ð´ÐµÑÑŒ.")

    elif text == "ðŸ’° KWT / Ð‘Ð°Ñ€":
        update.message.reply_text("ðŸ’° Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'KWT / Ð‘Ð°Ñ€'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.")

    else:
        # Ð›ÑŽÐ±Ð¾Ð¹ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
        update.message.reply_text(
            "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ:",
            reply_markup=ReplyKeyboardMarkup(
                MAIN_MENU,
                resize_keyboard=True,
                one_time_keyboard=True
            )
        )

def main():
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
    dp.add_handler(CommandHandler("start", start))

    # Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ: ÑÐ»ÑƒÑˆÐ°ÐµÐ¼ Ð²ÑÐµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    dp.add_handler(MessageHandler(Filters.text & Filters.regex("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ’° KWT / Ð‘Ð°Ñ€"), main_menu_handler))

    # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ shops.py
    dp.add_handler(get_conversation_handler())

    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
