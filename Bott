from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import CallbackContext
from geopy.geocoders import Nominatim

geolocator = Nominatim(user_agent="kwt-bot")

# состояния ConversationHandler
ADD_STORE_NAME, ADD_STORE_LOCATION = range(2)

# словарь магазинов
stores = {}

# Шаг 1: просим название магазина
def add_store_name(update: Update, context: CallbackContext):
    update.message.reply_text(
        "Напишите название магазина:",
        reply_markup=ReplyKeyboardMarkup(
            [["Назад"]],
            one_time_keyboard=True,
            resize_keyboard=True
        )
    )
    return ADD_STORE_NAME  # ждем, пока пользователь отправит текст

# Шаг 2: получаем название магазина и просим локацию
def add_store_location(update: Update, context: CallbackContext):
    # если это текст названия
    store_name = update.message.text
    if store_name.lower() == "назад":
        update.message.reply_text("Вы вернулись назад.")
        return -1

    context.user_data["store_name"] = store_name

    # теперь просим локацию
    update.message.reply_text(
        "Добавьте адрес магазина.\n⚠️ Убедитесь, что GPS включён!\nНажмите кнопку 'Поделиться местоположением'.",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("Поделиться местоположением", request_location=True)]],
            one_time_keyboard=True
        )
    )
    return ADD_STORE_LOCATION  # ждем локацию

# Шаг 3: получаем геолокацию и сохраняем магазин
def store_location_received(update: Update, context: CallbackContext):
    loc = update.message.location
    if not loc:
        update.message.reply_text("Не удалось получить локацию. Попробуйте снова.")
        return ADD_STORE_LOCATION

    coords = (loc.latitude, loc.longitude)
    address = geolocator.reverse(coords).address
    store_name = context.user_data["store_name"]
    stores[store_name] = {"coords": coords, "address": address, "products": []}

    update.message.reply_text(f"Магазин '{store_name}' добавлен с адресом:\n{address}")

    return -1  # конец ConversationHandler
