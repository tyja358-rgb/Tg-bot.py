from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount
from db import init_db

TOKEN = "8465624288:AAGKPaKjgGKxOZ3e1xN4pFTI_gTzP3KiVjc"

# Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ ÐºÐ½Ð¾Ð¿ÐºÐ¸
MAIN_MENU = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ’° KWT / Ð‘Ð°Ñ€"]]

def main_menu(update: Update, context: CallbackContext):
    """ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ"""
    context.user_data.clear()
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:",
        reply_markup=ReplyKeyboardMarkup(
            MAIN_MENU,
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )

def start(update: Update, context: CallbackContext):
    """ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start"""
    main_menu(update, context)

def main_menu_handler(update: Update, context: CallbackContext):
    """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ"""
    text = update.message.text

    if text == "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ":
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÐ¸Ð´ÐºÐ¸ Ð¸Ð· shops.py
        return start_discount(update, context)

    elif text == "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ":
        # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ°: Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÐ¸
        update.message.reply_text(
            "ðŸ” Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ'.\nÐ—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÐºÐ¸Ð´Ð¾Ðº."
        )
        # ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÐºÐ¸Ð´Ð¾Ðº Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
        main_menu(update, context)

    elif text == "ðŸ’° KWT / Ð‘Ð°Ñ€":
        # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ°: Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ KWT / Ð‘Ð°Ñ€
        update.message.reply_text(
            "ðŸ’° Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'KWT / Ð‘Ð°Ñ€'.\nÐ—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» KWT / Ð‘Ð°Ñ€."
        )
        # ÐŸÐ¾ÑÐ»Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
        main_menu(update, context)

    else:
        update.message.reply_text(
            "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ:",
            reply_markup=ReplyKeyboardMarkup(
                MAIN_MENU,
                resize_keyboard=True,
                one_time_keyboard=True
            )
        )

def main():
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
    dp.add_handler(CommandHandler("start", start))

    # Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ: ÑÐ»ÑƒÑˆÐ°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ
    dp.add_handler(
        MessageHandler(
            Filters.text & Filters.regex("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ’° KWT / Ð‘Ð°Ñ€"),
            main_menu_handler
        )
    )

    # ConversationHandler Ð´Ð»Ñ shops.py (Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸)
    dp.add_handler(get_conversation_handler())

    # Ð¡Ñ‚Ð°Ñ€Ñ‚ polling
    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
