from telegram import (
    Update,
    ReplyKeyboardMarkup,
    KeyboardButton
)
from telegram.ext import (
    ConversationHandler,
    MessageHandler,
    Filters,
    CallbackContext
)

(
    PHOTO,
    PRICE_BEFORE,
    PRICE_AFTER,
    CURRENCY,
    LOCATION,
    STORE_SELECT,
    STORE_NAME
) = range(7)

# --- –ü–ê–ú–Ø–¢–¨ ---
addresses = {}   # address -> [shops]
discounts = []


# --- –°–¢–ê–†–¢ ---
def start_discount(update: Update, context: CallbackContext):
    update.message.reply_text(
        "üì∏ –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Å–∫–∏–¥–∫–∏\n"
        "–¢–æ–≤–∞—Ä –∏ —Ü–µ–Ω–Ω–∏–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–∞–¥—Ä–µ"
    )
    return PHOTO


# --- –§–û–¢–û ---
def get_photo(update: Update, context: CallbackContext):
    context.user_data.clear()
    context.user_data["photo"] = update.message.photo[-1].file_id
    update.message.reply_text("üí∞ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –î–û")
    return PRICE_BEFORE


# --- –¶–ï–ù–ê –î–û ---
def price_before(update: Update, context: CallbackContext):
    try:
        context.user_data["before"] = float(update.message.text)
    except:
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
        return PRICE_BEFORE

    update.message.reply_text("üîª –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ü–û–°–õ–ï")
    return PRICE_AFTER


# --- –¶–ï–ù–ê –ü–û–°–õ–ï ---
def price_after(update: Update, context: CallbackContext):
    try:
        context.user_data["after"] = float(update.message.text)
    except:
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
        return PRICE_AFTER

    keyboard = [["MDL", "EUR", "USD"]]
    update.message.reply_text(
        "üí± –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )
    return CURRENCY


# --- –í–ê–õ–Æ–¢–ê ---
def currency(update: Update, context: CallbackContext):
    cur = update.message.text
    if cur not in ["MDL", "EUR", "USD"]:
        return CURRENCY

    before = context.user_data["before"]
    after = context.user_data["after"]
    discount = (before - after) / before * 100

    if discount < 20:
        update.message.reply_text(
            f"‚ùå –°–∫–∏–¥–∫–∞ {discount:.1f}%\n–ú–∏–Ω–∏–º—É–º 20%"
        )
        return ConversationHandler.END

    context.user_data["currency"] = cur
    context.user_data["discount"] = discount

    update.message.reply_text(
        "üìç –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –º–∞–≥–∞–∑–∏–Ω–∞\n"
        "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GPS –≤–∫–ª—é—á—ë–Ω",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π", request_location=True)]],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )
    return LOCATION


# --- –õ–û–ö–ê–¶–ò–Ø ---
def location(update: Update, context: CallbackContext):
    loc = update.message.location
    address = f"{round(loc.latitude,4)}, {round(loc.longitude,4)}"
    context.user_data["address"] = address

    shops = addresses.get(address, [])

    if shops:
        keyboard = [[s] for s in sorted(shops)]
        keyboard.append(["‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞"])
        update.message.reply_text(
            "üè¨ –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        )
        return STORE_SELECT

    update.message.reply_text("‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞")
    return STORE_NAME


# --- –í–´–ë–û–† –ú–ê–ì–ê–ó–ò–ù–ê ---
def select_store(update: Update, context: CallbackContext):
    if update.message.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞":
        update.message.reply_text("‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞")
        return STORE_NAME

    context.user_data["store"] = update.message.text
    return finish(update, context)


# --- –ù–ê–ó–í–ê–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê ---
def store_name(update: Update, context: CallbackContext):
    name = update.message.text
    addr = context.user_data["address"]

    addresses.setdefault(addr, []).append(name)
    context.user_data["store"] = name

    return finish(update, context)


# --- –§–ò–ù–ò–® ---
def finish(update: Update, context: CallbackContext):
    d = context.user_data
    discounts.append(d.copy())

    update.message.reply_text(
        f"‚úÖ –°–∫–∏–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞\n"
        f"üè¨ {d['store']}\n"
        f"üí∞ {d['before']} ‚Üí {d['after']} {d['currency']}\n"
        f"üìä {d['discount']:.1f}%"
    )
    return ConversationHandler.END


# --- –≠–ö–°–ü–û–†–¢ HANDLER ---
def get_conversation_handler():
    return ConversationHandler(
        entry_points=[
            MessageHandler(
                Filters.regex("^‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É$"),
                start_discount
            )
        ],
        states={
            PHOTO: [MessageHandler(Filters.photo, get_photo)],
            PRICE_BEFORE: [MessageHandler(Filters.text, price_before)],
            PRICE_AFTER: [MessageHandler(Filters.text, price_after)],
            CURRENCY: [MessageHandler(Filters.text, currency)],
            LOCATION: [MessageHandler(Filters.location, location)],
            STORE_SELECT: [MessageHandler(Filters.text, select_store)],
            STORE_NAME: [MessageHandler(Filters.text, store_name)],
        },
        fallbacks=[]
    )
