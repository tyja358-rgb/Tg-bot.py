from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount  # Ð²Ð°Ñˆ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ shops.py
from db import init_db

TOKEN = "Ð’ÐÐ¨_Ð¢ÐžÐšÐ•Ð_Ð—Ð”Ð•Ð¡Ð¬"

# Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ ÐºÐ½Ð¾Ð¿ÐºÐ¸
MAIN_MENU = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ’° KWT / Ð‘Ð°Ñ€"]]

def start(update: Update, context: CallbackContext):
    """Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð±Ð¾Ñ‚Ð° Ð¸ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ"""
    context.user_data.clear()
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
    )

def main_menu_handler(update: Update, context: CallbackContext):
    """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ"""
    text = update.message.text

    # Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÐ¸Ð´ÐºÐ¸ â€” Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ðµ Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ðµ
    if context.user_data.get("in_discount_flow"):
        update.message.reply_text(
            "Ð’Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Â«âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°Â».",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        return

    if text == "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ":
        context.user_data.clear()
        context.user_data["in_discount_flow"] = True  # Ð¿Ð¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
        return start_discount(update, context)

    elif text == "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ":
        return show_discounts(update, context)

    elif text == "ðŸ’° KWT / Ð‘Ð°Ñ€":
        update.message.reply_text(
            "ðŸ’° Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'KWT / Ð‘Ð°Ñ€'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    else:
        update.message.reply_text(
            "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

def show_discounts(update: Update, context: CallbackContext):
    """ÐŸÐ¾ÐºÐ°Ð· Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… N ÑÐºÐ¸Ð´Ð¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ„Ð¾Ñ‚Ð¾, Ñ†ÐµÐ½Ð°, % ÑÐºÐ¸Ð´ÐºÐ¸)"""
    from shops import discounts  # Ð±ÐµÑ€Ñ‘Ð¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸ Ð¸Ð· shops.py

    if not discounts:
        update.message.reply_text(
            "Ð¡ÐºÐ¸Ð´Ð¾Ðº Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ ðŸ˜”",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        return

    # Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñƒ ÑÐºÐ¸Ð´ÐºÐ¸, Ð¾Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµÐ³Ð¾ Ðº Ð¼ÐµÐ½ÑŒÑˆÐµÐ¼Ñƒ
    sorted_discounts = sorted(discounts, key=lambda d: d.get("discount", 0), reverse=True)

    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 ÑÐºÐ¸Ð´Ð¾Ðº
    for d in sorted_discounts[:5]:
        text = f"ðŸ’° {d['before']} â†’ {d['after']} {d['currency']}\nðŸ“Š {d['discount']:.1f}%"
        update.message.reply_photo(
            photo=d['photo'],
            caption=text
        )

    # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
    update.message.reply_text(
        "Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ:",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
    )

def main():
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
    dp.add_handler(CommandHandler("start", start))

    # Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ: ÑÐ»ÑƒÑˆÐ°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ
    dp.add_handler(MessageHandler(
        Filters.text & Filters.regex("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ’° KWT / Ð‘Ð°Ñ€"),
        main_menu_handler
    ))

    # ConversationHandler Ð´Ð»Ñ shops.py (Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸)
    dp.add_handler(get_conversation_handler())

    # Ð¡Ñ‚Ð°Ñ€Ñ‚ polling
    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
