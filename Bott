from geopy.geocoders import Nominatim
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton
from telegram.ext import ConversationHandler, MessageHandler, Filters, CallbackContext

# --- Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð¯ ---
PHOTO, PRICE_BEFORE, PRICE_AFTER, CURRENCY, LOCATION, STORE_SELECT, STORE_NAME = range(7)

# --- ÐŸÐÐœÐ¯Ð¢Ð¬ ---
stores = {}         # store_name -> {"coords": (), "address": "", "products": []}
addresses = {}      # address -> [store_name]
discounts = []

# --- Ð“Ð•ÐžÐ›ÐžÐšÐÐ¢ÐžÐ  ---
geolocator = Nominatim(user_agent="kwt-bot")

# --- ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ ---
BACK = "â¬…ï¸ ÐÐ°Ð·Ð°Ð´"
CANCEL = "âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°"

def nav_keyboard():
    return ReplyKeyboardMarkup([[BACK, CANCEL]], resize_keyboard=True)

# --- Ð¡Ð¢ÐÐ Ð¢ ---
def start_discount(update: Update, context: CallbackContext):
    update.message.reply_text(
        "ðŸ“¸ Ð¡Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ ÑÐºÐ¸Ð´ÐºÐ¸.\n"
        "Ð¢Ð¾Ð²Ð°Ñ€ Ð¸ Ñ†ÐµÐ½Ð½Ð¸Ðº Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð² ÐºÐ°Ð´Ñ€Ðµ.\n"
        "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ðŸ“Ž â†’ ÐšÐ°Ð¼ÐµÑ€Ð°, ÑÐ´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾.\n"
    )
    return PHOTO

# --- Ð¤ÐžÐ¢Ðž ---
def get_photo(update: Update, context: CallbackContext):
    context.user_data.clear()
    context.user_data["photo"] = update.message.photo[-1].file_id
    update.message.reply_text("ðŸ’° Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ†ÐµÐ½Ñƒ Ð”Ðž")
    return PRICE_BEFORE

# --- Ð¦Ð•ÐÐ Ð”Ðž ---
def price_before(update: Update, context: CallbackContext):
    try:
        context.user_data["before"] = float(update.message.text)
    except:
        update.message.reply_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾")
        return PRICE_BEFORE
    update.message.reply_text("ðŸ”» Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ†ÐµÐ½Ñƒ ÐŸÐžÐ¡Ð›Ð•")
    return PRICE_AFTER

# --- Ð¦Ð•ÐÐ ÐŸÐžÐ¡Ð›Ð• ---
def price_after(update: Update, context: CallbackContext):
    try:
        context.user_data["after"] = float(update.message.text)
    except:
        update.message.reply_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾")
        return PRICE_AFTER
    keyboard = [["MDL", "EUR", "USD"]]
    update.message.reply_text(
        "ðŸ’± Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð°Ð»ÑŽÑ‚Ñƒ",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )
    return CURRENCY

# --- Ð’ÐÐ›Ð®Ð¢Ð ---
def currency(update: Update, context: CallbackContext):
    cur = update.message.text
    if cur not in ["MDL", "EUR", "USD"]:
        return CURRENCY
    context.user_data["currency"] = cur
    before = context.user_data["before"]
    after = context.user_data["after"]
    discount = (before - after) / before * 100
    context.user_data["discount"] = discount
    update.message.reply_text(
        "ðŸ“ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°\nÐ£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ GPS Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("ðŸ“ ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÐµÐ¹", request_location=True)]],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )
    return LOCATION

# --- Ð›ÐžÐšÐÐ¦Ð˜Ð¯ ---
def add_store_location(update: Update, context: CallbackContext):
    loc = update.message.location
    if not loc:
        update.message.reply_text("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        return LOCATION
    coords = (loc.latitude, loc.longitude)
    address = geolocator.reverse(coords).address
    context.user_data["address"] = address
    existing_stores = [name for name, data in stores.items() if data["address"] == address]
    keyboard = [[s] for s in sorted(existing_stores)] if existing_stores else []
    keyboard.append(["âž• ÐÐ¾Ð²Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½"])
    update.message.reply_text(
        f"ÐÐ´Ñ€ÐµÑ: {address}\nðŸ¬ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )
    return STORE_SELECT

# --- Ð’Ð«Ð‘ÐžÐ  ÐœÐÐ“ÐÐ—Ð˜ÐÐ ---
def store_select(update, context):
    choice = update.message.text
    if choice == "âž• ÐÐ¾Ð²Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½":
        update.message.reply_text("âœï¸ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°:", reply_markup=ReplyKeyboardRemove())
        return STORE_NAME
    context.user_data["store"] = choice
    return finish(update, context)

# --- ÐÐÐ—Ð’ÐÐÐ˜Ð• ÐœÐÐ“ÐÐ—Ð˜ÐÐ ---
def store_name(update, context):
    name = update.message.text
    addr = context.user_data["address"]
    addresses.setdefault(addr, []).append(name)
    stores[name] = {
        "coords": (update.message.location.latitude, update.message.location.longitude) if update.message.location else None,
        "address": addr,
        "products": []
    }
    context.user_data["store"] = name
    return finish(update, context)

# --- Ð¤Ð˜ÐÐ˜Ð¨ ---
def finish(update, context):
    d = context.user_data
    discounts.append(d.copy())
    update.message.reply_text(
        f"âœ… Ð¡ÐºÐ¸Ð´ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°\n"
        f"ðŸ¬ {d['store']}\n"
        f"ðŸ’° {d['before']} â†’ {d['after']} {d['currency']}\n"
        f"ðŸ“Š {d['discount']:.1f}%\n"
        f"ðŸ“ {d.get('address','ÐÐ´Ñ€ÐµÑ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½')}",
        reply_markup=ReplyKeyboardMarkup([["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ"]], resize_keyboard=True, one_time_keyboard=True)
    )
    context.user_data.clear()
    return ConversationHandler.END

# --- Ð­ÐšÐ¡ÐŸÐžÐ Ð¢ HANDLER ---
def get_conversation_handler():
    return ConversationHandler(
        entry_points=[MessageHandler(Filters.regex("^âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ$"), start_discount)],
        states={
            PHOTO: [MessageHandler(Filters.photo, get_photo)],
            PRICE_BEFORE: [MessageHandler(Filters.text, price_before)],
            PRICE_AFTER: [MessageHandler(Filters.text, price_after)],
            CURRENCY: [MessageHandler(Filters.text, currency)],
            LOCATION: [MessageHandler(Filters.location, add_store_location)],
            STORE_SELECT: [MessageHandler(Filters.text, store_select)],
            STORE_NAME: [MessageHandler(Filters.text, store_name)],
        },
        fallbacks=[]
    )









from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler
from shops import get_conversation_handler  # Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑÑŒ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ ÑÐºÐ¸Ð´Ð¾Ðº

TOKEN = "Ð’ÐÐ¨_Ð¢ÐžÐšÐ•Ð_Ð—Ð”Ð•Ð¡Ð¬"  # Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÐ²Ð¾Ð¹ Ñ‚Ð¾ÐºÐµÐ½

def start(update: Update, context):
    context.user_data.clear()
    keyboard = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ"]]
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹",
        reply_markup=ReplyKeyboardMarkup(
            keyboard, resize_keyboard=True, one_time_keyboard=True
        )
    )

def main():
    print(">>> MAIN STARTED <<<")
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
    dp.add_handler(CommandHandler("start", start))

    # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ ÑÐºÐ¸Ð´Ð¾Ðº Ð¸Ð· shops.py
    dp.add_handler(get_conversation_handler())

    # Ð¡Ñ‚Ð°Ñ€Ñ‚ polling
    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()








