from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from shops import discounts  # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–∫–∏–¥–æ–∫ –∏–∑ shops.py

TOKEN = "8465624288:AAGKPaKjgGKxOZ3e1xN4pFTI_gTzP3KiVjc"

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
MAIN_MENU = [["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É", "üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É", "üí∞ KWT / –ë–∞—Ä"]]

def start(update: Update, context: CallbackContext):
    context.user_data.clear()
    update.message.reply_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
    )

# --- –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É ---
def find_discount(update: Update, context: CallbackContext):
    if not discounts:
        update.message.reply_text(
            "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–∏–¥–æ–∫ üòî",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        return

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
    sorted_discounts = sorted(discounts, key=lambda x: x["discount"], reverse=True)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ user_data, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –ø–æ –∫–Ω–æ–ø–∫–µ
    context.user_data["view_discounts"] = sorted_discounts
    context.user_data["index"] = 0  # —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è

    show_next_discount(update, context)

def show_next_discount(update: Update, context: CallbackContext):
    idx = context.user_data.get("index", 0)
    discounts_list = context.user_data.get("view_discounts", [])

    if idx >= len(discounts_list):
        # –ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        update.message.reply_text(
            "‚úÖ –í—Å–µ —Å–∫–∏–¥–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        context.user_data.pop("view_discounts", None)
        context.user_data.pop("index", None)
        return

    d = discounts_list[idx]

    # –§–æ—Ç–æ, –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, —Ü–µ–Ω–∞, –ø—Ä–æ—Ü–µ–Ω—Ç
    if "photo" in d:
        update.message.reply_photo(d["photo"])

    msg = (
        f"üõç {d.get('product','–¢–æ–≤–∞—Ä')}\n"
        f"üí∞ {d['before']} ‚Üí {d['after']} {d['currency']}\n"
        f"üìä {d['discount']:.1f}%"
    )
    update.message.reply_text(msg)

    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
    update.message.reply_text(
        "–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –º–∞–≥–∞–∑–∏–Ω –∏ –∞–¥—Ä–µ—Å, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:",
        reply_markup=ReplyKeyboardMarkup(
            [["üé¨ –ü–æ–∫–∞–∑–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω (–ø–æ—Å–ª–µ —Ä–µ–∫–ª–∞–º—ã)"], ["‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è —Å–∫–∏–¥–∫–∞"], ["üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–∫–∏–¥–æ–∫ ---
def discount_buttons(update: Update, context: CallbackContext):
    text = update.message.text
    idx = context.user_data.get("index", 0)
    discounts_list = context.user_data.get("view_discounts", [])

    if text == "üé¨ –ü–æ–∫–∞–∑–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω (–ø–æ—Å–ª–µ —Ä–µ–∫–ª–∞–º—ã)":
        if idx < len(discounts_list):
            d = discounts_list[idx]
            update.message.reply_text(
                f"üè¨ {d.get('store','–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
                f"üìç {d.get('address','–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}"
            )
    elif text == "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è —Å–∫–∏–¥–∫–∞":
        context.user_data["index"] = idx + 1
        show_next_discount(update, context)
        return
    elif text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        update.message.reply_text(
            "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        context.user_data.pop("view_discounts", None)
        context.user_data.pop("index", None)
        return

# --- MAIN ---
def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.regex("^üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É$"), find_discount))
    dp.add_handler(MessageHandler(Filters.text & Filters.regex("üé¨ –ü–æ–∫–∞–∑–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω|‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è —Å–∫–∏–¥–∫–∞|üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"), discount_buttons))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
