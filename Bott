from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount  # Ñ‚Ð²Ð¾Ð¹ shops.py
from db import init_db

TOKEN = "Ð’ÐÐ¨_Ð¢ÐžÐšÐ•Ð_Ð—Ð”Ð•Ð¡Ð¬"

MAIN_MENU = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ’° KWT / Ð‘Ð°Ñ€"]]

def start(update: Update, context: CallbackContext):
    context.user_data.clear()
    context.user_data["in_discount_flow"] = False
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
    )

def main_menu_handler(update: Update, context: CallbackContext):
    text = update.message.text

    # ðŸ”¹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÐ¸Ð´ÐºÐ¸
    if text == "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ":
        if context.user_data.get("in_discount_flow"):
            update.message.reply_text(
                "Ð’Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸. Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°.",
                reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
            )
            return
        context.user_data["in_discount_flow"] = True
        return start_discount(update, context)

    elif text == "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ":
        update.message.reply_text(
            "ðŸ” Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    elif text == "ðŸ’° KWT / Ð‘Ð°Ñ€":
        update.message.reply_text(
            "ðŸ’° Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'KWT / Ð‘Ð°Ñ€'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    else:
        update.message.reply_text(
            "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

def main():
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.text & Filters.regex("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ’° KWT / Ð‘Ð°Ñ€"), main_menu_handler))

    # Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ConversationHandler Ð¸Ð· shops.py
    dp.add_handler(get_conversation_handler())

    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
