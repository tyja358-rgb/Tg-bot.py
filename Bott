from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount

TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
MAIN_MENU = [["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É", "üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É", "üí∞ KWT / –ë–∞—Ä"]]

def start(update: Update, context: CallbackContext):
    """–°—Ç–∞—Ä—Ç –±–æ—Ç–∞ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    context.user_data.clear()
    update.message.reply_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
    )

def main_menu_handler(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    text = update.message.text

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
    if context.user_data.get("in_discount_flow"):
        update.message.reply_text(
            "–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )
        return

    if text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É":
        context.user_data["in_discount_flow"] = True
        return start_discount(update, context)

    elif text == "üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É":
        update.message.reply_text(
            "üîç –í—ã –Ω–∞–∂–∞–ª–∏ '–ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É'. –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    elif text == "üí∞ KWT / –ë–∞—Ä":
        update.message.reply_text(
            "üí∞ –í—ã –Ω–∞–∂–∞–ª–∏ 'KWT / –ë–∞—Ä'. –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    else:
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # –ö–æ–º–∞–Ω–¥–∞ /start
    dp.add_handler(CommandHandler("start", start))

    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å–ª—É—à–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
    dp.add_handler(MessageHandler(Filters.text & Filters.regex("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É|üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É|üí∞ KWT / –ë–∞—Ä"), main_menu_handler))

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–∫–∏–¥–æ–∫ –∏–∑ shops.py
    dp.add_handler(get_conversation_handler())

    # –°—Ç–∞—Ä—Ç polling
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
