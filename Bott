from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler  # —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏

TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
def main_menu_keyboard():
    return ReplyKeyboardMarkup(
        [["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É", "üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É"],
         ["üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å KWT", "üìä –ë–∞—Ä"]],
        resize_keyboard=True,
        one_time_keyboard=True
    )

def start(update: Update, context: CallbackContext):
    context.user_data.clear()
    update.message.reply_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã",
        reply_markup=main_menu_keyboard()
    )

# --- –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É ---
def search_discount(update: Update, context: CallbackContext):
    update.message.reply_text("üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–∫–∏–¥–æ–∫:")
    return 1  # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è ConversationHandler –ø–æ–∏—Å–∫–∞

# --- –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å KWT ---
def earn_kwt(update: Update, context: CallbackContext):
    update.message.reply_text(
        "üí∞ –ß—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å KWT:\n"
        "1. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–∫–∏–¥–∫–∏.\n"
        "2. –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π.\n"
        "3. –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∞–∫—Ü–∏–∏ –∏ –∑–∞–¥–∞–Ω–∏—è.\n"
    )
    return 1  # –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

# --- –ë–∞—Ä ---
def bar_status(update: Update, context: CallbackContext):
    kwt_balance = context.user_data.get("kwt_balance", 0)
    update.message.reply_text(f"üìä –í–∞—à –±–∞–ª–∞–Ω—Å KWT: {kwt_balance}")

# --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---
def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
    dp.add_handler(get_conversation_handler())

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
    dp.add_handler(MessageHandler(Filters.regex("üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É"), search_discount))
    dp.add_handler(MessageHandler(Filters.regex("üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å KWT"), earn_kwt))
    dp.add_handler(MessageHandler(Filters.regex("üìä –ë–∞—Ä"), bar_status))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
