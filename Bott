from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, ConversationHandler, CallbackContext
from geopy.geocoders import Nominatim

# --- –°–û–°–¢–û–Ø–ù–ò–Ø ---
PHOTO, PRICE_BEFORE, PRICE_AFTER, CURRENCY, LOCATION, STORE_SELECT, STORE_NAME = range(7)

# --- –ü–ê–ú–Ø–¢–¨ ---
stores = {}          # store_name -> {"coords": (), "address": "", "products": []}
addresses = {}       # address -> [store_name]
discounts = []

# --- –ì–ï–û–õ–û–ö–ê–¢–û–† ---
geolocator = Nominatim(user_agent="kwt-bot")

# --- –ö–õ–ê–í–ò–ê–¢–£–†–´ ---
MAIN_MENU = [["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É", "üîç –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É", "üí∞ KWT / –ë–∞—Ä"]]
def main_menu_keyboard():
    return ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)

NAV_BUTTONS = ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚ùå –û—Ç–º–µ–Ω–∞"]
def nav_keyboard():
    return ReplyKeyboardMarkup([NAV_BUTTONS], resize_keyboard=True, one_time_keyboard=True)

# --- –°–¢–ê–†–¢ ---
def start(update: Update, context: CallbackContext):
    context.user_data.clear()
    update.message.reply_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã", reply_markup=main_menu_keyboard())

# --- –§–û–¢–û ---
def start_discount(update: Update, context: CallbackContext):
    context.user_data.clear()
    update.message.reply_text(
        "üì∏ –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Å–∫–∏–¥–∫–∏.\n"
        "–¢–æ–≤–∞—Ä –∏ —Ü–µ–Ω–Ω–∏–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–∞–¥—Ä–µ.\n"
        "–ù–∞–∂–º–∏—Ç–µ üìé ‚Üí –ö–∞–º–µ—Ä–∞, —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ.\n"
    )
    return PHOTO

def get_photo(update: Update, context: CallbackContext):
    context.user_data["photo"] = update.message.photo[-1].file_id
    keyboard = [["‚¨áÔ∏è –í–≤–µ—Å—Ç–∏ —Ü–µ–Ω—É –î–û"]]
    update.message.reply_text("üí∞ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –î–û", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
    return PRICE_BEFORE

# --- –¶–ï–ù–ê –î–û ---
def price_before(update: Update, context: CallbackContext):
    text = update.message.text
    if text in NAV_BUTTONS:
        return handle_nav(update, context)
    try:
        context.user_data["before"] = float(text)
    except ValueError:
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
        return PRICE_BEFORE

    update.message.reply_text("üîª –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ü–û–°–õ–ï", reply_markup=nav_keyboard())
    return PRICE_AFTER

# --- –¶–ï–ù–ê –ü–û–°–õ–ï ---
def price_after(update: Update, context: CallbackContext):
    text = update.message.text
    if text in NAV_BUTTONS:
        return handle_nav(update, context)
    try:
        context.user_data["after"] = float(text)
    except ValueError:
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
        return PRICE_AFTER

    keyboard = [["MDL", "EUR", "USD"]]
    update.message.reply_text("üí± –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
    return CURRENCY

# --- –í–ê–õ–Æ–¢–ê ---
def currency(update: Update, context: CallbackContext):
    text = update.message.text
    if text in NAV_BUTTONS:
        return handle_nav(update, context)
    if text not in ["MDL", "EUR", "USD"]:
        update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö")
        return CURRENCY

    before = context.user_data["before"]
    after = context.user_data["after"]
    discount = (before - after) / before * 100
    if discount < 20:
        update.message.reply_text(f"‚ùå –°–∫–∏–¥–∫–∞ {discount:.1f}% ‚Äî –º–∏–Ω–∏–º—É–º 20%!")
        return ConversationHandler.END

    context.user_data["currency"] = text
    context.user_data["discount"] = discount

    # –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    update.message.reply_text(
        "üìç –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –º–∞–≥–∞–∑–∏–Ω–∞\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GPS –≤–∫–ª—é—á—ë–Ω",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π", request_location=True)]],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )
    return LOCATION

# --- –õ–û–ö–ê–¶–ò–Ø ---
def add_store_location(update: Update, context: CallbackContext):
    text = update.message.text
    if text in NAV_BUTTONS:
        return handle_nav(update, context)

    loc = update.message.location
    if not loc:
        update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return LOCATION

    coords = (loc.latitude, loc.longitude)
    address = geolocator.reverse(coords).address
    context.user_data["address"] = address

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞–≥–∞–∑–∏–Ω—ã
    existing_stores = [name for name, data in stores.items() if data["address"] == address]
    keyboard = [[s] for s in sorted(existing_stores)] if existing_stores else []
    keyboard.append(["‚ûï –ù–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω"])

    update.message.reply_text(
        f"–ê–¥—Ä–µ—Å: {address}\nüè¨ –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )
    return STORE_SELECT

# --- –í–´–ë–û–† –ú–ê–ì–ê–ó–ò–ù–ê ---
def store_select(update: Update, context: CallbackContext):
    choice = update.message.text
    if choice in NAV_BUTTONS:
        return handle_nav(update, context)
    if choice == "‚ûï –ù–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω":
        update.message.reply_text("‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:", reply_markup=ReplyKeyboardRemove())
        return STORE_NAME

    # –≤—ã–±—Ä–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞–≥–∞–∑–∏–Ω
    context.user_data["store"] = choice
    return finish(update, context)

# --- –ù–ê–ó–í–ê–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê ---
def store_name(update: Update, context: CallbackContext):
    text = update.message.text
    if text in NAV_BUTTONS:
        return handle_nav(update, context)

    addr = context.user_data["address"]
    addresses.setdefault(addr, []).append(text)
    stores[text] = {"coords": None, "address": addr, "products": []}
    context.user_data["store"] = text
    return finish(update, context)

# --- –§–ò–ù–ò–® ---
def finish(update: Update, context: CallbackContext):
    d = context.user_data
    discounts.append(d.copy())
    update.message.reply_text(
        f"‚úÖ –°–∫–∏–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞\n"
        f"üè¨ {d['store']}\n"
        f"üí∞ {d['before']} ‚Üí {d['after']} {d['currency']}\n"
        f"üìä {d['discount']:.1f}%\n"
        f"üìç {d.get('address','–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω')}",
        reply_markup=main_menu_keyboard()
    )
    context.user_data.clear()
    return ConversationHandler.END

# --- –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ---
def handle_nav(update: Update, context: CallbackContext):
    text = update.message.text
    if text == "‚ùå –û—Ç–º–µ–Ω–∞":
        update.message.reply_text("–ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ë–Ω", reply_markup=main_menu_keyboard())
        context.user_data.clear()
        return ConversationHandler.END
    if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
        # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ "–Ω–∞–∑–∞–¥": –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å context.user_data["last_step"]
        update.message.reply_text("‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É", reply_markup=main_menu_keyboard())
        return ConversationHandler.END
    return ConversationHandler.END

# --- HANDLER ---
def get_conversation_handler():
    return ConversationHandler(
        entry_points=[MessageHandler(Filters.regex("^‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É$"), start_discount)],
        states={
            PHOTO: [MessageHandler(Filters.photo, get_photo)],
            PRICE_BEFORE: [MessageHandler(Filters.text, price_before)],
            PRICE_AFTER: [MessageHandler(Filters.text, price_after)],
            CURRENCY: [MessageHandler(Filters.text, currency)],
            LOCATION: [MessageHandler(Filters.location, add_store_location)],
            STORE_SELECT: [MessageHandler(Filters.text, store_select)],
            STORE_NAME: [MessageHandler(Filters.text, store_name)],
        },
        fallbacks=[]
    )

# --- MAIN ---
def main():
    from db import init_db
    from telegram.ext import Updater
    TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(get_conversation_handler())
    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
