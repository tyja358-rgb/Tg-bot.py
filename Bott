from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

from shops import get_conversation_handler, start_discount  # Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Ñ‚Ð²Ð¾ÐµÐ³Ð¾ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ
from db import init_db

TOKEN = "8465624288:AAGKPaKjgGKxOZ3e1xN4pFTI_gTzP3KiVjc"

# Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ ÐºÐ½Ð¾Ð¿ÐºÐ¸
MAIN_MENU = [["âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ", "ðŸ’° KWT / Ð‘Ð°Ñ€"]]

def start(update: Update, context: CallbackContext):
    """Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð±Ð¾Ñ‚Ð° Ð¸ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ"""
    context.user_data.clear()
    context.user_data["in_discount_flow"] = False  # Ð¿Ð¾ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ
    update.message.reply_text(
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ‘‹\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:",
        reply_markup=ReplyKeyboardMarkup(
            MAIN_MENU,
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )

def main_menu_handler(update: Update, context: CallbackContext):
    """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ"""
    text = update.message.text

    # Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÐ¸Ð´ÐºÐ¸ â€” Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð·Ð°Ð½Ð¾Ð²Ð¾
    if text == "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ":
        if context.user_data.get("in_discount_flow"):
            update.message.reply_text(
                "Ð’Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ¸Ð´ÐºÐ¸. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°.",
                reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
            )
            return

        context.user_data["in_discount_flow"] = True
        return start_discount(update, context)

    elif text == "ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ":
        update.message.reply_text(
            "ðŸ” Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    elif text == "ðŸ’° KWT / Ð‘Ð°Ñ€":
        update.message.reply_text(
            "ðŸ’° Ð’Ñ‹ Ð½Ð°Ð¶Ð°Ð»Ð¸ 'KWT / Ð‘Ð°Ñ€'. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°.",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

    else:
        update.message.reply_text(
            "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ:",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True, one_time_keyboard=True)
        )

def main():
    print(">>> MAIN STARTED <<<")
    init_db()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
    dp.add_handler(CommandHandler("start", start))

    # Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ: ÑÐ»ÑƒÑˆÐ°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ
    dp.add_handler(MessageHandler(
        Filters.text & Filters.regex("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ ÑÐºÐ¸Ð´ÐºÑƒ|ðŸ’° KWT / Ð‘Ð°Ñ€"),
        main_menu_handler
    ))

    # ConversationHandler Ð´Ð»Ñ shops.py
    dp.add_handler(get_conversation_handler())

    # Ð¡Ñ‚Ð°Ñ€Ñ‚ polling
    updater.start_polling()
    print(">>> POLLING START <<<")
    updater.idle()

if __name__ == "__main__":
    main()
